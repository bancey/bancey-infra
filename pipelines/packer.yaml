parameters:
  - name: packerVarsFile
    type: string
  - name: packerConfigFile
    type: string
  - name: keyVaultName
    type: string
  - name: serviceConnection
    type: string

steps:
  - task: AzureKeyVault@2
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      KeyVaultName: ${{ parameters.keyVaultName }}
      SecretsFilter: "*"
      RunAsPreJob: true
  - task: replacetokens@3
    displayName: "Populate files with values from KeyVault"
    inputs:
      targetFiles: ${{ parameters.packerVarsFile }}
      encoding: auto
      writeBOM: true
      actionOnMissing: fail
      keepToken: true
      tokenPrefix: $(
      tokenSuffix: )
      useLegacyPattern: false
      enableTransforms: false
      enableTelemetry: false
  - task: CmdLine@2
    inputs:
      script: |
        packer -version
        echo 'packer validate -var-file="${{ parameters.packerVarsFile }}" -var "proxmox_api_token_id=$(Wanda-Proxmox-Token-ID)" -var "proxmox_api_token_secret=$(Wanda-Proxmox-Token-Secret)" ${{ parameters.packerConfigFile }}'
        packer validate -var-file="${{ parameters.packerVarsFile }}" -var "proxmox_api_token_id=$(Wanda-Proxmox-Token-ID)" -var "proxmox_api_token_secret=$(Wanda-Proxmox-Token-Secret)" ${{ parameters.packerConfigFile }}
